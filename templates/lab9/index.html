{% extends "base.html" %}
{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<link rel="stylesheet" href="{{ url_for('static', filename='lab9/lab9.css') }}">

<div class="new-year-theme">

  <div class="stats-panel">
    <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ üéÅ</h1>

    <!-- –ö–ù–û–ü–ö–ò –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ü–†–Ø–ú–û –ù–ê –°–¢–†–ê–ù–ò–¶–ï -->
    <div class="auth-panel">
      {% if is_logged_in %}
        <span>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ <b>{{ session.login }}</b></span>
        <button class="santa-btn" type="button" onclick="santa()">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
        <a class="auth-btn" href="/lab9/logout">–í—ã–π—Ç–∏</a>
      {% else %}
        <a class="auth-btn" href="/lab9/login12">–í–æ–π—Ç–∏</a>
        <a class="auth-btn" href="/lab9/register12">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      {% endif %}
    </div>

    <p>–ù–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: <b id="closed-count">{{ closed_count }}</b> / {{ box_count }}</p>
    <p>–¢—ã –æ—Ç–∫—Ä—ã–ª(–∞): <b id="user-opened-count">{{ opened_count }}</b> / 3</p>
  </div>

  <!-- POPUP (–∫–∞–∫ —É –¥—Ä—É–≥–∞, –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è onclick) -->
  <div id="gift-popup" class="gift-popup" style="display:none;">
    <div class="gift-popup-content">
      <button class="close-popup" onclick="closeGiftPopup()">√ó</button>
      <h3>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
      <p id="gift-message-text"></p>
      <div id="gift-preview"></div>
      <button class="ok-button" onclick="closeGiftPopup()">OK</button>
    </div>
  </div>

  <!-- –ö–û–†–û–ë–ö–ò -->
  <div class="boxes-container">
    {% for b in boxes %}
      <div class="gift-box {% if b.id in opened_global %}opened{% endif %}"
           data-id="{{ b.id }}"
           style="left: {{ b.left }}%; top: {{ b.top }}%;">
        <div class="box-content">
          <img
            class="box-img"
            src="{% if b.id in opened_global %}
                   {{ url_for('static', filename='lab9/opened_box.png') }}
                 {% else %}
                   {{ url_for('static', filename='lab9/box_closed_' ~ (b.id+1) ~ '.png') }}
                 {% endif %}"
            alt="–ö–æ—Ä–æ–±–∫–∞ {{ b.id+1 }}"
          >
          <div class="box-status">{% if b.id in opened_global %}–û—Ç–∫—Ä—ã—Ç–∞{% else %}–ó–∞–∫—Ä—ã—Ç–∞{% endif %}</div>
          <div class="box-number">–ö–æ—Ä–æ–±–∫–∞ {{ b.id+1 }}</div>
        </div>
      </div>
    {% endfor %}
  </div>

</div>

<script>
function closeGiftPopup() {
  document.getElementById('gift-popup').style.display = 'none';
}

function showGiftPopup(message, giftImage) {
  document.getElementById('gift-message-text').textContent = message || "";
  if (giftImage) {
    document.getElementById('gift-preview').innerHTML =
      `<img src="{{ url_for('static', filename='') }}${giftImage}" alt="–ü–æ–¥–∞—Ä–æ–∫" style="max-width: 320px;">`;
  } else {
    document.getElementById('gift-preview').innerHTML = "";
  }
  document.getElementById('gift-popup').style.display = 'flex';
}

function updateBoxAfterOpen(boxElement) {
  const img = boxElement.querySelector('.box-img');
  if (img) img.src = "{{ url_for('static', filename='lab9/opened_box.png') }}";
  const status = boxElement.querySelector('.box-status');
  if (status) status.textContent = '–û—Ç–∫—Ä—ã—Ç–∞';
  boxElement.classList.add('opened');
}

async function openBox(boxId, boxElement) {
  const res = await fetch('/lab9/api/open', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({id: boxId})
  });
  const data = await res.json();

  if (!data.ok && data.authRequired) {
    showGiftPopup(data.message || "–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏", null);
    return;
  }
  if (!data.ok && data.limitReached) {
    showGiftPopup(data.message || "–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ –±–æ–ª—å—à–µ 3 –∫–æ—Ä–æ–±–æ–∫ üôÇ", null);
    return;
  }
  if (!data.ok) {
    showGiftPopup(data.error || "–û—à–∏–±–∫–∞", null);
    return;
  }

  if (data.alreadyOpened) {
    updateBoxAfterOpen(boxElement);
    return;
  }

  document.getElementById('user-opened-count').textContent = data.openedCount;
  document.getElementById('closed-count').textContent = data.remaining;

  showGiftPopup(data.greeting, data.giftImage);
  updateBoxAfterOpen(boxElement);
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.gift-box').forEach(box => {
    box.addEventListener('click', () => {
      if (box.classList.contains('opened')) return;
      openBox(parseInt(box.dataset.id), box);
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeGiftPopup();
  });
});

async function santa() {
  const res = await fetch('/lab9/api/santa', {method: 'POST'});
  const data = await res.json();
  showGiftPopup(data.message || "–ì–æ—Ç–æ–≤–æ!", null);
  if (data.ok) setTimeout(() => location.reload(), 300);
}
</script>

{% endblock %}
